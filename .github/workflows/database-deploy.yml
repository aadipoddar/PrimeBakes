name: Deploy Database to Azure

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  version-check:
    uses: ./.github/workflows/version-checks.yml

  deploy-database:
    runs-on: windows-latest
    needs: version-check
    if: needs.version-check.outputs.should-deploy == 'true'

    steps:
    - uses: actions/checkout@v4
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    
    - name: Build SQL Server Database Project
      run: msbuild DBPrimeBakes/DBPrimeBakes.sqlproj /p:Configuration=Release /p:Platform="Any CPU"
    
    - name: Find DACPAC file
      run: |
        Get-ChildItem -Path "DBPrimeBakes" -Filter "*.dacpac" -Recurse | Select-Object FullName
    
    - name: Install SqlPackage
      run: |
        Invoke-WebRequest -Uri "https://aka.ms/sqlpackage-windows" -OutFile "SqlPackage.zip"
        Expand-Archive -Path "SqlPackage.zip" -DestinationPath "SqlPackage"
    
    - name: Deploy Database to Azure SQL
      run: |
        $dacpacPath = (Get-ChildItem -Path "DBPrimeBakes" -Filter "DBPrimeBakes.dacpac" -Recurse).FullName
        echo "Using DACPAC: $dacpacPath"
        ./SqlPackage/SqlPackage.exe /Action:Publish `
          /SourceFile:"$dacpacPath" `
          /TargetConnectionString:"${{ secrets.AzureConnectionString }}" `
          /p:IncludeCompositeObjects=True
    
    - name: Deployment Summary
      run: |
        echo "ðŸš€ Successfully deployed database version ${{ needs.version-check.outputs.current-version }} to Azure SQL"
