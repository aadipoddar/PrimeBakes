name: Version Checks

on:
  workflow_call:
    outputs:
      should-deploy:
        description: "Whether deployment should proceed"
        value: ${{ jobs.version-check.outputs.should-deploy }}
      current-version:
        description: "Current version from README"
        value: ${{ jobs.version-check.outputs.current-version }}

jobs:
  version-check:
    runs-on: windows-latest
    outputs:
      should-deploy: ${{ steps.final-decision.outputs.should-deploy }}
      current-version: ${{ steps.extract-version.outputs.version }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Extract current version from README
        id: extract-version
        run: |
          $VERSION = (Get-Content README.md | Select-String -Pattern 'version-([0-9.]+)-blue').Matches.Groups[1].Value
          echo "version=$VERSION" >> $env:GITHUB_OUTPUT
          echo "Current version: $VERSION"
      
      - name: Get previous version
        id: get-previous
        run: |
          git checkout HEAD~1 2>$null
          $PREV_VERSION = (Get-Content README.md -ErrorAction SilentlyContinue | Select-String -Pattern 'version-([0-9.]+)-blue').Matches.Groups[1].Value
          if (-not $PREV_VERSION) { $PREV_VERSION = "none" }
          echo "previous=$PREV_VERSION" >> $env:GITHUB_OUTPUT
          echo "Previous version: $PREV_VERSION"
          git checkout -
      
      - name: Compare versions
        id: version-compare
        run: |
          $CURRENT = "${{ steps.extract-version.outputs.version }}"
          $PREVIOUS = "${{ steps.get-previous.outputs.previous }}"
          
          if ($CURRENT -ne $PREVIOUS) {
            echo "version-changed=true" >> $env:GITHUB_OUTPUT
            echo "‚úÖ Version changed: $PREVIOUS ‚Üí $CURRENT"
          } else {
            echo "version-changed=false" >> $env:GITHUB_OUTPUT
            echo "‚è≠Ô∏è Version unchanged ($CURRENT)"
          }
      
      - name: Verify Azure Connection String
        id: connection-check
        run: |
          $CONNECTION_LINE = Get-Content PrimeBakesLibrary/DataAccess/SqlDataAccess.cs | Select-String "_databaseConnection = Secrets"
          
          if ($CONNECTION_LINE -match "Secrets.AzureConnectionString") {
            echo "connection-valid=true" >> $env:GITHUB_OUTPUT
            echo "‚úÖ Using Azure connection string - Safe for deployment"
          } elseif ($CONNECTION_LINE -match "Secrets.LocalConnectionString") {
            echo "connection-valid=false" >> $env:GITHUB_OUTPUT
            echo "‚è≠Ô∏è Local connection string detected - Skipping deployment"
          } else {
            echo "connection-valid=false" >> $env:GITHUB_OUTPUT
            echo "‚è≠Ô∏è Unknown connection string configuration - Skipping deployment"
          }
      
      - name: Verify Assembly Version matches README
        id: assembly-check
        run: |
          $README_VERSION = "${{ steps.extract-version.outputs.version }}"
          $ASSEMBLY_VERSION = (Get-Content PrimeBakes/PrimeBakes.Shared/PrimeBakes.Shared.csproj | Select-String -Pattern '<AssemblyVersion>([^<]+)</AssemblyVersion>').Matches.Groups[1].Value
          
          if ($README_VERSION -eq $ASSEMBLY_VERSION) {
            echo "assembly-valid=true" >> $env:GITHUB_OUTPUT
            echo "‚úÖ Assembly version matches README: $ASSEMBLY_VERSION"
          } else {
            echo "assembly-valid=false" >> $env:GITHUB_OUTPUT
            echo "‚è≠Ô∏è Version mismatch - README: $README_VERSION, Assembly: $ASSEMBLY_VERSION - Skipping deployment"
          }
      
      - name: Verify Android Manifest Version
        id: android-check
        run: |
          $README_VERSION = "${{ steps.extract-version.outputs.version }}"
          $ANDROID_VERSION = (Get-Content PrimeBakes/PrimeBakes/Platforms/Android/AndroidManifest.xml | Select-String -Pattern 'android:versionName="([^"]+)"').Matches.Groups[1].Value
          $ANDROID_CODE = (Get-Content PrimeBakes/PrimeBakes/Platforms/Android/AndroidManifest.xml | Select-String -Pattern 'android:versionCode="([^"]+)"').Matches.Groups[1].Value
          
          # Get previous versionCode
          git checkout HEAD~1 2>$null
          $PREV_ANDROID_CODE = (Get-Content PrimeBakes/PrimeBakes/Platforms/Android/AndroidManifest.xml -ErrorAction SilentlyContinue | Select-String -Pattern 'android:versionCode="([^"]+)"').Matches.Groups[1].Value
          if (-not $PREV_ANDROID_CODE) { $PREV_ANDROID_CODE = "0" }
          git checkout -
          
          # Check version name matches
          if ($README_VERSION -ne $ANDROID_VERSION) {
            echo "android-valid=false" >> $env:GITHUB_OUTPUT
            echo "‚è≠Ô∏è Version mismatch - README: $README_VERSION, Android: $ANDROID_VERSION - Skipping deployment"
            return
          }
          
          # Check version code is greater
          if ([int]$ANDROID_CODE -le [int]$PREV_ANDROID_CODE) {
            echo "android-valid=false" >> $env:GITHUB_OUTPUT
            echo "‚è≠Ô∏è Android versionCode not incremented - Current: $ANDROID_CODE, Previous: $PREV_ANDROID_CODE - Skipping deployment"
            return
          }
          
          echo "android-valid=true" >> $env:GITHUB_OUTPUT
          echo "‚úÖ Android version valid - Name: $ANDROID_VERSION, Code: $PREV_ANDROID_CODE ‚Üí $ANDROID_CODE"
      
      - name: Final deployment decision
        id: final-decision
        run: |
          $VERSION_CHANGED = "${{ steps.version-compare.outputs.version-changed }}"
          $CONNECTION_VALID = "${{ steps.connection-check.outputs.connection-valid }}"
          $ASSEMBLY_VALID = "${{ steps.assembly-check.outputs.assembly-valid }}"
          $ANDROID_VALID = "${{ steps.android-check.outputs.android-valid }}"
          
          if (($VERSION_CHANGED -eq "true") -and ($CONNECTION_VALID -eq "true") -and ($ASSEMBLY_VALID -eq "true") -and ($ANDROID_VALID -eq "true")) {
            echo "should-deploy=true" >> $env:GITHUB_OUTPUT
            echo "üöÄ All checks passed - Deployment will proceed"
          } else {
            echo "should-deploy=false" >> $env:GITHUB_OUTPUT
            echo "‚õî Deployment blocked - Requirements not met"
          }
