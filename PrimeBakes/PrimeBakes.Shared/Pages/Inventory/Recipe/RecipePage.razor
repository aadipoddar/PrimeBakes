@attribute [Route(PageRouteNames.Recipe)]

@using PrimeBakesLibrary.Models.Inventory;
@using PrimeBakesLibrary.Models.Operations;
@using PrimeBakesLibrary.Models.Store.Product;

<PageTitle>Recipe - Prime Bakes</PageTitle>

@if (_isLoading)
{
	<AnimatedLoader Visible="true" />
}
else
{
	<div class="page-shell">
		<Header Title="Product Recipe Management" Subtitle="Create and manage product recipes with raw material quantities"
				ShowLogout="true" ShowHome="true" ShowBack="true" OnHomeClick="NavigateToDashboard" OnBackClick="NavigateBack"
				OnLogoutClick="Logout">
			<RightContent>
				<IconButton Icon="IconType.Save" Variant="ButtonVariant.Save" Title="Save Recipe (Ctrl + S)"
							Disabled="_isProcessing" OnClick="OnSaveButtonClick" />
				@if (_recipe is not null && _recipe.Id > 0)
				{
					<IconButton Icon="IconType.Delete" Variant="ButtonVariant.Delete" Title="Delete Recipe"
								Disabled="_isProcessing" OnClick="DeleteRecipe" />
				}
				<IconButton Icon="IconType.New" Title="New Recipe (Ctrl + N)" Disabled="_isProcessing"
							OnClick="ResetPage" />
			</RightContent>
		</Header>

		<!-- Main Content Container -->
		<div class="page-container">

			<!-- Product Selection Section -->
			<div class="section-card">
				<div class="section-header">
					<div class="section-title-wrapper">
						<svg class="section-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
							 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
							 stroke-linejoin="round">
							<circle cx="12" cy="12" r="10" />
							<line x1="2" y1="12" x2="22" y2="12" />
							<path
							d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" />
						</svg>
						<h2 class="section-title">Select Product</h2>
					</div>
				</div>
				<div class="section-body">
					<div class="form-grid">
						<div class="form-field">
							<label class="field-label">
								Product <span class="required">*</span>
							</label>
							<SfAutoComplete Value="@_selectedProduct" TValue="ProductLocationOverviewModel"
											TItem="ProductLocationOverviewModel" DataSource="@_products" Placeholder="Select a Product"
											FloatLabelType="FloatLabelType.Never" AllowFiltering="true"
											FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains" CssClass="custom-autocomplete">
								<AutoCompleteEvents TItem="ProductLocationOverviewModel"
													TValue="ProductLocationOverviewModel" ValueChange="OnProductChanged" />
								<AutoCompleteFieldSettings Value="Name" />
							</SfAutoComplete>
						</div>
					</div>
				</div>
			</div>

			<!-- Add Raw Material to Recipe Section -->
			<div class="section-card">
				<div class="section-header">
					<div class="section-title-wrapper">
						<svg class="section-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
							 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
							 stroke-linejoin="round">
							<circle cx="9" cy="21" r="1" />
							<circle cx="20" cy="21" r="1" />
							<path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
						</svg>
						<h2 class="section-title">Add Raw Material to Recipe</h2>
					</div>
				</div>
				<div class="section-body">
					<!-- Single Row: Raw Material and Quantity -->
					<div class="cart-input-row">
						<div class="cart-field cart-field-wide">
							<label class="cart-label">Raw Material <span class="required">*</span></label>
							<SfAutoComplete @ref="_sfItemAutoComplete" @bind-Value="@_selectedRawMaterial"
											TValue="RawMaterialModel?" TItem="RawMaterialModel" DataSource="@_rawMaterials"
											Placeholder="Select Raw Material" FloatLabelType="FloatLabelType.Never"
											AllowFiltering="true" FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains"
											CssClass="custom-autocomplete">
								<AutoCompleteFieldSettings Value="Name" />
							</SfAutoComplete>
						</div>

						<div class="cart-field">
							<label class="cart-label">Quantity <span class="required">*</span></label>
							<SfNumericTextBox @bind-Value="_selectedRawMaterialQuantity" TValue="decimal" Min="0"
											  ShowSpinButton="false" Placeholder="0.00" FloatLabelType="FloatLabelType.Never"
											  CssClass="custom-numeric editable-field" />
						</div>

						<div class="cart-field">
							<label class="cart-label" style="visibility: hidden;">Action</label>
							<IconButton Icon="IconType.Add" Variant="ButtonVariant.Add" Text="Add" Title="Add to Cart"
										Disabled="_isProcessing" OnClick="AddItemToCart" />
						</div>
					</div>
				</div>
			</div>

			<!-- Recipe Items Grid Section -->
			<div class="section-card">
				<div class="section-header">
					<div class="section-title-wrapper">
						<svg class="section-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
							 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
							 stroke-linejoin="round">
							<path d="M3 3h7a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H3V3z" />
							<path d="M14 3h7v17h-7V3z" />
						</svg>
						<h2 class="section-title">Recipe Items</h2>
					</div>
				</div>
				<div class="section-body grid-body">
					<SfGrid ID="_sfCartGrid" @ref="_sfCartGrid" DataSource="_recipeItems" AllowTextWrap="true"
							AllowPaging="false" AllowSorting="true" AllowResizing="true" AllowFiltering="true"
							GridLines="GridLine.Horizontal" CssClass="professional-grid"
							Toolbar="@(new List<string>() { "Search" })">

						<GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Excel" />

						<GridAggregates>
							<GridAggregate>
								<GridAggregateColumns>
									<GridAggregateColumn Field="@nameof(RecipeItemCartModel.ItemName)"
														 Type="AggregateType.Count">
										<FooterTemplate>
											@{
												var aggregate = (context as AggregateTemplateContext);
											}
											<div class="aggregate-label">
												<strong>Total Items: @aggregate.Count</strong>
											</div>
										</FooterTemplate>
									</GridAggregateColumn>
									<GridAggregateColumn Field="@nameof(RecipeItemCartModel.Quantity)"
														 Type="AggregateType.Sum">
										<FooterTemplate>
											@{
												var aggregate = (context as AggregateTemplateContext);
												var sum = aggregate.Sum != null ? Convert.ToDecimal(aggregate.Sum) : 0m;
											}
											<div class="aggregate-value">
												<strong>@sum.ToString("N2")</strong>
											</div>
										</FooterTemplate>
									</GridAggregateColumn>
								</GridAggregateColumns>
							</GridAggregate>
						</GridAggregates>

						<GridColumns>
							<GridColumn HeaderText="Actions" Width="120" TextAlign="TextAlign.Center">
								<Template>
									@{
										var item = (context as RecipeItemCartModel);
									}
									<div class="grid-actions">
										<IconButton Icon="IconType.Edit" Variant="ButtonVariant.Edit" Size="ButtonSize.Grid"
													Title="Edit Item" Disabled="@_isProcessing"
													OnClick="@(() => EditCartItem(item))" />
										<IconButton Icon="IconType.Delete" Variant="ButtonVariant.Delete"
													Size="ButtonSize.Grid" Title="Remove Item" Disabled="@_isProcessing"
													OnClick="@(() => RemoveItemFromCart(item))" />
									</div>
								</Template>
							</GridColumn>
							<GridColumn Field="@nameof(RecipeItemCartModel.ItemName)" HeaderText="Raw Material Name"
										Width="250" />
							<GridColumn Field="@nameof(RecipeItemCartModel.Quantity)" HeaderText="Quantity" Width="150"
										TextAlign="TextAlign.Right" Format="N2" />
						</GridColumns>
					</SfGrid>
				</div>
			</div>
		</div>

		<Footer />
	</div>
}

<ToastNotification @ref="_toastNotification" />