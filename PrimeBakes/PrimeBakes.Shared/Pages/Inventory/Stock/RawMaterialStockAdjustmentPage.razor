@attribute [Route(PageRouteNames.RawMaterialStockAdjustment)]

@using PrimeBakesLibrary.Models.Accounts.Masters
@using PrimeBakesLibrary.Models.Operations
@using PrimeBakesLibrary.Models.Inventory

<PageTitle>Raw Material Stock Adjustment - Prime Bakes</PageTitle>

@if (_isLoading || _user is null)
{
	<AnimatedLoader Visible="true" />
}
else
{
	<div class="page-shell">
		<Header Title="Create Raw Material Stock Adjustment" Subtitle="Create and manage raw material stock adjustments"
				ShowLogout="true" ShowHome="true" ShowBack="true" OnHomeClick="NavigateToDashboard" OnBackClick="NavigateBack"
				OnLogoutClick="Logout">
			<RightContent>
				<IconButton Icon="IconType.Save" Variant="ButtonVariant.Save" Title="Save Transaction (Ctrl + S)"
							Disabled="_isProcessing" OnClick="SaveTransaction" />
				<IconButton Icon="IconType.History" Title="Transaction History (Ctrl + H)" Disabled="_isProcessing"
							OnClick="NavigateToTransactionHistoryPage" />
				<IconButton Icon="IconType.New" Title="New Transaction (Ctrl + N)" Disabled="_isProcessing"
							OnClick="ResetPage" />
			</RightContent>
		</Header>

		<!-- Main Content Container -->
		<div class="page-container">

			<!-- Top Section: Transaction Summary -->
			<div class="section-card">
				<div class="section-header">
					<div class="section-title-wrapper">
						<svg class="section-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
							 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
							 stroke-linejoin="round">
							<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
							<polyline points="14 2 14 8 20 8" />
							<line x1="16" y1="13" x2="8" y2="13" />
							<line x1="16" y1="17" x2="8" y2="17" />
							<polyline points="10 9 9 9 8 9" />
						</svg>
						<h2 class="section-title">Transaction Summary</h2>
					</div>
				</div>
				<div class="section-body">
					<div class="form-grid">
						<!-- Transaction Date and Financial Year -->
						<div class="form-field">
							<label class="field-label">
								Transaction Date <span class="required">*</span>
							</label>
							<SfDatePicker Value="@_transactionDateTime" TValue="DateTime" Format="dd/MM/yy"
										  Placeholder="Select Date" FloatLabelType="FloatLabelType.Never"
										  CssClass="custom-datepicker">
								<DatePickerEvents TValue="DateTime" ValueChange="OnTransactionDateChanged" />
							</SfDatePicker>
						</div>

						<div class="form-field">
							<label class="field-label">
								Financial Year
							</label>
							<SfTextBox
							Value="@($"{_selectedFinancialYear?.StartDate:yyyy} to {_selectedFinancialYear?.EndDate:yyyy}")"
							Readonly="true" Placeholder="Financial Year" FloatLabelType="FloatLabelType.Never"
							CssClass="custom-textbox readonly-field" />
						</div>

						<!-- Transaction No -->
						<div class="form-field">
							<label class="field-label">
								Transaction No <span class="required">*</span>
							</label>
							<SfTextBox @bind-Value="_transactionNo" Placeholder="Enter Transaction No"
									   FloatLabelType="FloatLabelType.Never" Readonly=true
									   CssClass="custom-textbox readonly-field" />
						</div>
					</div>
				</div>
			</div>

			<!-- Add to Cart Section -->
			<div class="section-card">
				<div class="section-header">
					<div class="section-title-wrapper">
						<svg class="section-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
							 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
							 stroke-linejoin="round">
							<circle cx="9" cy="21" r="1" />
							<circle cx="20" cy="21" r="1" />
							<path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
						</svg>
						<h2 class="section-title">Add Item to Cart</h2>
					</div>
				</div>
				<div class="section-body">
					<div class="cart-input-row">
						<!-- Item Selection -->
						<div class="cart-field cart-field-wide">
							<label class="field-label">Item Name <span class="required">*</span></label>
							<SfAutoComplete @ref="_sfItemAutoComplete" Value="@_selectedRawMaterial"
											TValue="RawMaterialModel?" TItem="RawMaterialModel" DataSource="@_rawMaterials"
											Placeholder="Select Item (Ctrl + E)" FloatLabelType="FloatLabelType.Never"
											AllowFiltering="true" FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains"
											CssClass="custom-autocomplete">
								<AutoCompleteEvents TItem="RawMaterialModel" TValue="RawMaterialModel?"
													ValueChange="OnItemChanged" />
								<AutoCompleteFieldSettings Value="Name" />
							</SfAutoComplete>
						</div>

						<!-- Current Stock -->
						<div class="cart-field">
							<label class="field-label">Current Stock</label>
							<SfNumericTextBox Value="@_selectedCart.Stock" TValue="decimal" ShowSpinButton="false"
											  Readonly="true" FloatLabelType="FloatLabelType.Never" CssClass="custom-numeric" />
						</div>

						<!-- New Quantity -->
						<div class="cart-field">
							<label class="field-label">New Quantity <span class="required">*</span></label>
							<SfNumericTextBox Value="@_selectedCart.Quantity" TValue="decimal" ShowSpinButton="false"
											  Placeholder="0.00" FloatLabelType="FloatLabelType.Never"
											  CssClass="custom-numeric editable-field">
								<NumericTextBoxEvents TValue="decimal" ValueChange="OnItemQuantityChanged" />
							</SfNumericTextBox>
						</div>

						<!-- Rate -->
						<div class="cart-field">
							<label class="field-label">Rate</label>
							<SfNumericTextBox Value="@_selectedCart.Rate" TValue="decimal" ShowSpinButton="false"
											  Readonly="true" FloatLabelType="FloatLabelType.Never" CssClass="custom-numeric" />
						</div>

						<!-- Total -->
						<div class="form-field">
							<label class="field-label">Total Amount</label>
							<SfNumericTextBox Value="@_selectedCart.Total" TValue="decimal" ShowSpinButton="false"
											  Readonly="true" FloatLabelType="FloatLabelType.Never" CssClass="custom-numeric" />
						</div>

						<!-- Add Button -->
						<div class="form-field form-field-button">
							<label class="field-label">&nbsp;</label>
							<IconButton Icon="IconType.Add" Variant="ButtonVariant.Add" Text="Add to Cart"
										Title="Add to Cart" OnClick="AddItemToCart" />
						</div>
					</div>
				</div>
			</div>

			<!-- Cart Items Grid Section -->
			<div class="section-card">
				<div class="section-header">
					<div class="section-title-wrapper">
						<svg class="section-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
							 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
							 stroke-linejoin="round">
							<path d="M3 3h7a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H3V3z" />
							<path d="M14 3h7v17h-7V3z" />
						</svg>
						<h2 class="section-title">Adjustment Items</h2>
					</div>
				</div>
				<div class="section-body grid-body">
					<SfGrid ID="_sfCartGrid" @ref="_sfCartGrid" DataSource="_cart" AllowTextWrap="true" AllowPaging="false"
							AllowSorting="true" AllowResizing="true" AllowFiltering="true" GridLines="GridLine.Horizontal"
							CssClass="professional-grid" Toolbar="@(new List<string>() { "Search" })">

						<GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Excel" />

						<GridAggregates>
							<GridAggregate>
								<GridAggregateColumns>
									<GridAggregateColumn Field="RawMaterialName" Type="AggregateType.Count">
										<FooterTemplate>
											@{
												var aggregate = (context as AggregateTemplateContext);
											}
											<div class="aggregate-label">
												<strong>Total Items: @aggregate.Count</strong>
											</div>
										</FooterTemplate>
									</GridAggregateColumn>
									<GridAggregateColumn Field="Stock" Type="AggregateType.Sum">
										<FooterTemplate>
											@{
												var aggregate = (context as AggregateTemplateContext);
												var sum = aggregate.Sum != null ? Convert.ToDecimal(aggregate.Sum) : 0m;
											}
											<div class="aggregate-value">
												<strong>@sum.ToString("N2")</strong>
											</div>
										</FooterTemplate>
									</GridAggregateColumn>
									<GridAggregateColumn Field="Quantity" Type="AggregateType.Sum">
										<FooterTemplate>
											@{
												var aggregate = (context as AggregateTemplateContext);
												var sum = aggregate.Sum != null ? Convert.ToDecimal(aggregate.Sum) : 0m;
											}
											<div class="aggregate-value">
												<strong>@sum.ToString("N2")</strong>
											</div>
										</FooterTemplate>
									</GridAggregateColumn>
									<GridAggregateColumn Field="Total" Type="AggregateType.Sum">
										<FooterTemplate>
											@{
												var aggregate = (context as AggregateTemplateContext);
												var sum = aggregate.Sum != null ? Convert.ToDecimal(aggregate.Sum) : 0m;
											}
											<div class="aggregate-value aggregate-total">
												<strong>@sum.ToString("N2")</strong>
											</div>
										</FooterTemplate>
									</GridAggregateColumn>
								</GridAggregateColumns>
							</GridAggregate>
						</GridAggregates>

						<GridColumns>
							<GridColumn HeaderText="Actions" Width="100" TextAlign="TextAlign.Center">
								<Template>
									@{
										var item = (context as dynamic);
										<div class="grid-actions">
											<IconButton Icon="IconType.Edit" Variant="ButtonVariant.Edit" Size="ButtonSize.Grid"
														Title="Edit Item (Insert)" OnClick="@(() => EditCartItem(item))" />
											<IconButton Icon="IconType.Delete" Variant="ButtonVariant.Delete"
														Size="ButtonSize.Grid" Title="Remove Item (Del)"
														OnClick="@(() => RemoveItemFromCart(item))" />
										</div>
									}
								</Template>
							</GridColumn>
							<GridColumn Field="RawMaterialName" HeaderText="Item Name" Width="250" />
							<GridColumn Field="Stock" HeaderText="Current Stock" Width="130" TextAlign="TextAlign.Right"
										Format="N2" />
							<GridColumn Field="Quantity" HeaderText="New Qty" Width="120" TextAlign="TextAlign.Right"
										Format="N2" />
							<GridColumn Field="Rate" HeaderText="Rate" Width="110" TextAlign="TextAlign.Right"
										Format="N2" />
							<GridColumn Field="Total" HeaderText="Total" Width="150" TextAlign="TextAlign.Right"
										Format="N2">
								<Template>
									@{
										var item = (context as dynamic);
										<span class="grid-total">@item.Total.ToString("N2")</span>
									}
								</Template>
							</GridColumn>
						</GridColumns>
					</SfGrid>
				</div>
			</div>
		</div>

		<Footer />
	</div>
}

<ToastNotification @ref="_toastNotification" />
