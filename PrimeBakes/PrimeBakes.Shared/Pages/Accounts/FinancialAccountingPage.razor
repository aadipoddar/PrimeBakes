@attribute [Route(PageRouteNames.FinancialAccounting)]
@attribute [Route(PageRouteNames.FinancialAccounting + "/{Id:int}")]

@using PrimeBakesLibrary.Models.Accounts.FinancialAccounting
@using PrimeBakesLibrary.Models.Accounts.Masters

<PageTitle>Financial Accounting - Prime Bakes</PageTitle>

@if (_isLoading)
{
    <AnimatedLoader Visible="true" />
}
else
{
    <div style="display: flex; flex-direction: column; min-height: 100vh;">
        <Header Title="Financial Accounting Entry" Subtitle="Create and manage accounting voucher entries" ShowLogout="true"
                ShowHome="true" ShowBack="true" OnHomeClick="NavigateToDashboard" OnBackClick="NavigateBack"
                OnLogoutClick="Logout">
            <RightContent>
                <IconButton Icon="IconType.Save" Variant="ButtonVariant.Save" Title="Save Transaction (Ctrl + S)"
                            Disabled="_isProcessing" OnClick="SaveTransaction" />
                @if (Id.HasValue && Id.Value > 0)
                {
                    <IconButton Icon="IconType.Excel" Variant="ButtonVariant.Excel" Title="Download Excel Invoice (Alt+E)"
                                Disabled="_isProcessing" OnClick="DownloadExcelInvoice" />
                    <IconButton Icon="IconType.Pdf" Variant="ButtonVariant.Pdf" Title="Download PDF Invoice (Alt+P)"
                                Disabled="_isProcessing" OnClick="DownloadPdfInvoice" />
                }
                <IconButton Icon="IconType.History" Title="Transaction History (Ctrl + H)" Disabled="_isProcessing"
                            OnClick="NavigateToTransactionHistoryPage" />
                <IconButton Icon="IconType.Report" Title="Item Report (Ctrl + I)" Disabled="_isProcessing"
                            OnClick="NavigateToItemReport" />
                <IconButton Icon="IconType.TrialBalance" Title="Trial Balance (Ctrl + T)" Disabled="_isProcessing"
                            OnClick="NavigateToTrialBalance" />
                <IconButton Icon="IconType.ProfitAndLoss" Title="Profit & Loss (Alt+ F)" Disabled="_isProcessing"
                            OnClick="NavigateToProfitAndLoss" />
                <IconButton Icon="IconType.BalanceSheet" Title="Balance Sheet (Alt+ B)" Disabled="_isProcessing"
                            OnClick="NavigateToBalanceSheet" />
                <IconButton Icon="IconType.New" Title="New Transaction (Ctrl + N)" Disabled="_isProcessing"
                            OnClick="ResetPage" />
            </RightContent>
        </Header>

        <!-- Main Content Container -->
        <div class="page-container">

            <!-- Top Section: Transaction Summary -->
            <div class="two-column-layout">
                <!-- Transaction Summary Section -->
                <div class="section-card">
                    <div class="section-header">
                        <div class="section-title-wrapper">
                            <svg class="section-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                                 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                 stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                <polyline points="14 2 14 8 20 8" />
                                <line x1="16" y1="13" x2="8" y2="13" />
                                <line x1="16" y1="17" x2="8" y2="17" />
                                <polyline points="10 9 9 9 8 9" />
                            </svg>
                            <h2 class="section-title">Transaction Summary</h2>
                        </div>
                    </div>
                    <div class="section-body">
                        <div class="form-grid">
                            <!-- Company -->
                            <div class="form-field">
                                <label class="field-label">
                                    Company <span class="required">*</span>
                                </label>
                                <SfAutoComplete Value="@_selectedCompany" TValue="CompanyModel" TItem="CompanyModel"
                                                DataSource="@_companies" Placeholder="Select a Company"
                                                FloatLabelType="FloatLabelType.Never" AllowFiltering="true"
                                                FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains"
                                                CssClass="custom-autocomplete">
                                    <AutoCompleteEvents TItem="CompanyModel" TValue="CompanyModel"
                                                        ValueChange="OnCompanyChanged" />
                                    <AutoCompleteFieldSettings Value="Name" />
                                </SfAutoComplete>
                            </div>

                            <!-- Voucher -->
                            <div class="form-field">
                                <label class="field-label">
                                    Voucher <span class="required">*</span>
                                </label>
                                <SfAutoComplete Value="@_selectedVoucher" TValue="VoucherModel" TItem="VoucherModel"
                                                DataSource="@_vouchers" Placeholder="Select a Voucher"
                                                FloatLabelType="FloatLabelType.Never" AllowFiltering="true"
                                                FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains"
                                                CssClass="custom-autocomplete">
                                    <AutoCompleteEvents TItem="VoucherModel" TValue="VoucherModel"
                                                        ValueChange="OnPartyChanged" />
                                    <AutoCompleteFieldSettings Value="Name" />
                                </SfAutoComplete>
                            </div>

                            <!-- Transaction Date and Financial Year -->
                            <div class="form-field">
                                <label class="field-label">
                                    Transaction Date <span class="required">*</span> / Financial Year
                                </label>
                                <div class="date-year-wrapper">
                                    <SfDatePicker Value="@_accounting.TransactionDateTime" TValue="DateTime"
                                                  Format="dd/MM/yy" Placeholder="Select Date" FloatLabelType="FloatLabelType.Never"
                                                  CssClass="custom-datepicker">
                                        <DatePickerEvents TValue="DateTime" ValueChange="OnTransactionDateChanged" />
                                    </SfDatePicker>
                                    <SfTextBox Value="@($"{_selectedFinancialYear?.StartDate:yyyy} to {_selectedFinancialYear?.EndDate:yyyy}")"
                                               Readonly="true" Placeholder="Financial Year" FloatLabelType="FloatLabelType.Never"
                                               CssClass="custom-textbox readonly-field" />
                                </div>
                            </div>

                            <!-- Transaction No -->
                            <div class="form-field">
                                <label class="field-label">
                                    Transaction No
                                </label>
                                <SfTextBox @bind-Value="_accounting.TransactionNo" Placeholder="Enter Transaction No"
                                           FloatLabelType="FloatLabelType.Never" Readonly="true"
                                           CssClass="custom-textbox readonly-field" />
                            </div>

                            @if (_accounting.Id > 0 && _accounting.ReferenceId is not null && _accounting.ReferenceId > 0)
                            {
                                <!-- Reference No -->
                                <div class="form-field">
                                    <label class="field-label">
                                        Reference No
                                    </label>
                                    <div class="reference-wrapper">
                                        <SfTextBox @bind-Value="_accounting.ReferenceNo" Placeholder="Enter Reference No"
                                                   FloatLabelType="FloatLabelType.Never" Readonly="true"
                                                   CssClass="custom-textbox readonly-field" />
                                        @if (!string.IsNullOrEmpty(_accounting.ReferenceNo))
                                        {
                                            <div class="reference-actions">
                                                <IconButton Icon="IconType.View" Variant="ButtonVariant.View" Size="ButtonSize.Small"
                                                            Title="View Invoice" OnClick="ViewReferenceInvoice" />
                                                <IconButton Icon="IconType.Pdf" Variant="ButtonVariant.Pdf" Size="ButtonSize.Small"
                                                            Title="Download PDF Invoice" OnClick="DownloadReferenceInvoice" />
                                            </div>
                                        }
                                    </div>
                                </div>
                            }

                            <!-- Remarks -->
                            <div class="form-field">
                                <label class="field-label">
                                    Remarks / Narration
                                </label>
                                <SfTextBox @bind-Value="_accounting.Remarks" Multiline="true" Placeholder="Enter remarks..."
                                           FloatLabelType="FloatLabelType.Never" CssClass="custom-textbox" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Financial Summary Section -->
                <div class="section-card">
                    <div class="section-header">
                        <div class="section-title-wrapper">
                            <svg class="section-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                                 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                 stroke-linecap="round" stroke-linejoin="round">
                                <line x1="12" y1="1" x2="12" y2="23" />
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                            </svg>
                            <h2 class="section-title">Financial Summary</h2>
                        </div>
                    </div>
                    <div class="section-body">
                        <div class="financial-grid">
                            <!-- Total Credit -->
                            <div class="financial-row">
                                <label class="financial-label">Total Credit:</label>
                                <SfNumericTextBox Value="@_accounting.TotalCreditAmount" TValue="decimal" Readonly="true"
                                                  ShowSpinButton="false" Format="N2" Placeholder="0.00"
                                                  FloatLabelType="FloatLabelType.Never" CssClass="custom-numeric readonly-field" />
                            </div>

                            <!-- Total Debit -->
                            <div class="financial-row">
                                <label class="financial-label">Total Debit:</label>
                                <SfNumericTextBox Value="@_accounting.TotalDebitAmount" TValue="decimal" Readonly="true"
                                                  ShowSpinButton="false" Format="N2" Placeholder="0.00"
                                                  FloatLabelType="FloatLabelType.Never" CssClass="custom-numeric readonly-field" />
                            </div>

                            <!-- Difference -->
                            <div class="financial-row total-row">
                                <label class="financial-label-total">Difference:</label>
                                <SfNumericTextBox Value="@(_accounting.TotalDebitAmount - _accounting.TotalCreditAmount)"
                                                  TValue="decimal" Readonly="true" ShowSpinButton="false" Format="N2" Placeholder="0.00"
                                                  FloatLabelType="FloatLabelType.Never" CssClass="custom-numeric readonly-field" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add to Cart Section -->
            <div class="section-card">
                <div class="section-header">
                    <div class="section-title-wrapper">
                        <svg class="section-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                             viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                             stroke-linejoin="round">
                            <circle cx="9" cy="21" r="1" />
                            <circle cx="20" cy="21" r="1" />
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
                        </svg>
                        <h2 class="section-title">Add Ledger Entry</h2>
                    </div>
                </div>
                <div class="section-body">
                    <!-- Single Row: All Components -->
                    <div class="cart-input-row">
                        <div class="cart-field cart-field-wide">
                            <label class="cart-label">Ledger <span class="required">*</span></label>
                            <div class="reference-wrapper">
                                <SfAutoComplete @ref="_sfLedgerAutoComplete" Value="@_selectedLedger" TValue="LedgerModel ?"
                                                TItem="LedgerModel" DataSource="@_ledgers" Placeholder="Select Ledger (Ctrl + E)"
                                                FloatLabelType="FloatLabelType.Never" AllowFiltering="true"
                                                FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains" CssClass="custom-autocomplete">
                                    <AutoCompleteEvents TItem="LedgerModel" TValue="LedgerModel ?" ValueChange="OnItemChanged" />
                                    <AutoCompleteFieldSettings Value="Name" />
                                </SfAutoComplete>
                                <IconButton Icon="IconType.Get" Variant="ButtonVariant.Get" Size="ButtonSize.Small"
                                            Title="Get References" OnClick="GetReferences" />
                            </div>
                        </div>

                        <div class="cart-field cart-field-wide">
                            <label class="cart-label">Ref No</label>
                            <div class="reference-wrapper">
                                <SfAutoComplete Value="@_selectedAccountingLedger" TValue="FinancialAccountingLedgerOverviewModel"
                                                TItem="FinancialAccountingLedgerOverviewModel" DataSource="@_accountingLedgers"
                                                Placeholder="Select Reference" FloatLabelType="FloatLabelType.Never"
                                                AllowFiltering="true" FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains"
                                                CssClass="custom-autocomplete">
                                    <AutoCompleteEvents TItem="FinancialAccountingLedgerOverviewModel"
                                                        TValue="FinancialAccountingLedgerOverviewModel" ValueChange="OnReferenceChanged" />
                                    <AutoCompleteFieldSettings Value="ReferenceNo" />
                                </SfAutoComplete>
                                <div class="reference-actions">
                                    <IconButton Icon="IconType.View" Variant="ButtonVariant.View" Size="ButtonSize.Small"
                                                Title="View Invoice" OnClick="ViewCartReferenceInvoice" />
                                    <IconButton Icon="IconType.Pdf" Variant="ButtonVariant.Pdf" Size="ButtonSize.Small"
                                                Title="Download PDF Invoice" OnClick="DownloadCartReferenceInvoice" />
                                </div>
                            </div>
                        </div>

                        <div class="cart-field">
                            <label class="cart-label">Debit</label>
                            <SfNumericTextBox @bind-Value="_selectedCart.Debit" TValue="decimal?" Min="0"
                                              ShowSpinButton="false" Placeholder="0.00" FloatLabelType="FloatLabelType.Never" Format="N2"
                                              CssClass="custom-numeric editable-field" />
                        </div>

                        <div class="cart-field">
                            <label class="cart-label">Credit</label>
                            <SfNumericTextBox @bind-Value="_selectedCart.Credit" TValue="decimal?" Min="0"
                                              ShowSpinButton="false" Placeholder="0.00" FloatLabelType="FloatLabelType.Never" Format="N2"
                                              CssClass="custom-numeric editable-field" />
                        </div>


                        <div class="cart-field cart-field-wide">
                            <label class="cart-label">Remarks</label>
                            <SfTextBox @bind-Value="_selectedCart.Remarks" Placeholder="Entry narration..."
                                       FloatLabelType="FloatLabelType.Never" CssClass="custom-textbox" />
                        </div>

                        <div class="cart-field">
                            <IconButton Icon="IconType.Add" Variant="ButtonVariant.Add" Text="Add" Title="Add to Cart"
                                        OnClick="AddItemToCart" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cart Items Grid Section -->
            <div class="section-card">
                <div class="section-header">
                    <div class="section-title-wrapper">
                        <svg class="section-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                             viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                             stroke-linejoin="round">
                            <path d="M3 3h7a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H3V3z" />
                            <path d="M14 3h7v17h-7V3z" />
                        </svg>
                        <h2 class="section-title">Accounting Entries</h2>
                    </div>
                </div>
                <div class="section-body grid-body">
                    <SfGrid @ref="_sfCartGrid" DataSource="_cart" AllowTextWrap="true" AllowPaging="false"
                            AllowSorting="true" AllowResizing="true" AllowFiltering="true" GridLines="GridLine.Horizontal"
                            CssClass="professional-grid" Toolbar="@(new List<string>() { "Search" })">

                        <GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Excel" />

                        <GridAggregates>
                            <GridAggregate>
                                <GridAggregateColumns>
                                    <GridAggregateColumn Field="LedgerName" Type="AggregateType.Count">
                                        <FooterTemplate>
                                            @{
                                                var aggregate = (context as AggregateTemplateContext);
                                            }
                                            <div class="aggregate-label">
                                                <strong>Total Entries: @aggregate.Count</strong>
                                            </div>
                                        </FooterTemplate>
                                    </GridAggregateColumn>
                                    <GridAggregateColumn Field="Debit" Type="AggregateType.Sum">
                                        <FooterTemplate>
                                            @{
                                                var aggregate = (context as AggregateTemplateContext);
                                                var sum = aggregate.Sum != null ? Convert.ToDecimal(aggregate.Sum) : 0m;
                                            }
                                            <div class="aggregate-value aggregate-debit">
                                                <strong>@sum.ToString("N2")</strong>
                                            </div>
                                        </FooterTemplate>
                                    </GridAggregateColumn>
                                    <GridAggregateColumn Field="Credit" Type="AggregateType.Sum">
                                        <FooterTemplate>
                                            @{
                                                var aggregate = (context as AggregateTemplateContext);
                                                var sum = aggregate.Sum != null ? Convert.ToDecimal(aggregate.Sum) : 0m;
                                            }
                                            <div class="aggregate-value aggregate-credit">
                                                <strong>@sum.ToString("N2")</strong>
                                            </div>
                                        </FooterTemplate>
                                    </GridAggregateColumn>
                                </GridAggregateColumns>
                            </GridAggregate>
                        </GridAggregates>

                        <GridColumns>
                            <GridColumn HeaderText="Actions" Width="100" TextAlign="TextAlign.Center">
                                <Template>
                                    @{
                                        var item = (context as FinancialAccountingItemCartModel);
                                        <div class="grid-actions">
                                            <IconButton Icon="IconType.Edit" Variant="ButtonVariant.Edit" Size="ButtonSize.Grid"
                                                        Title="Edit Entry (Insert)" OnClick="@(() => EditCartItem(item))" />
                                            <IconButton Icon="IconType.Delete" Variant="ButtonVariant.Delete"
                                                        Size="ButtonSize.Grid" Title="Remove Entry (Del)"
                                                        OnClick="@(() => RemoveItemFromCart(item))" />
                                        </div>
                                    }
                                </Template>
                            </GridColumn>
                            <GridColumn Field="LedgerName" HeaderText="Ledger Name" Width="250" />
                            <GridColumn Field="Debit" HeaderText="Debit" Width="130" TextAlign="TextAlign.Right"
                                        Format="N2">
                                <Template>
                                    @{
                                        var item = (context as FinancialAccountingItemCartModel);
                                        <span class="@((item.Debit ?? 0) > 0 ? "grid-debit" : "")">
                                            @(item.Debit?.ToString("N2") ??
                                                                                "-")
                                        </span>
                                    }
                                </Template>
                            </GridColumn>
                            <GridColumn Field="Credit" HeaderText="Credit" Width="130" TextAlign="TextAlign.Right"
                                        Format="N2">
                                <Template>
                                    @{
                                        var item = (context as FinancialAccountingItemCartModel);
                                        <span class="@((item.Credit ?? 0) > 0 ? "grid-credit" : "")">
                                            @(item.Credit?.ToString("N2") ??
                                                                                "-")
                                        </span>
                                    }
                                </Template>
                            </GridColumn>
                            <GridColumn Field="ReferenceType" HeaderText="Ref Type" Width="120" />
                            <GridColumn Field="ReferenceNo" HeaderText="Ref No" Width="120" />
                            <GridColumn Field="Remarks" HeaderText="Remarks" Width="500" />
                        </GridColumns>
                    </SfGrid>
                </div>
            </div>
        </div>

        <Footer />
    </div>
}

<ToastNotification @ref="_toastNotification" />