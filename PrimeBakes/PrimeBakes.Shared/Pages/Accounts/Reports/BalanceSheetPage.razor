@attribute [Route(PageRouteNames.BalanceSheetReport)]

@using PrimeBakesLibrary.Models.Accounts.FinancialAccounting
@using PrimeBakesLibrary.Models.Accounts.Masters
@using PrimeBakesLibrary.Models.Operations

<PageTitle>Balance Sheet - Prime Bakes</PageTitle>

@if (_isLoading)
{
	<AnimatedLoader Visible="true" />
}
else
{
	<div class="page-shell">
		<Header Title="Balance Sheet" Subtitle="View assets and liabilities for specified period" ShowHome="true"
				ShowBack="true" ShowLogout="true" OnHomeClick="NavigateToDashboard" OnBackClick="NavigateBack"
				OnLogoutClick="Logout">
			<RightContent>
				<IconButton Icon="IconType.Excel" Variant="ButtonVariant.Excel" Title="Export to Excel (Ctrl + E)"
							Disabled="_isProcessing" OnClick="ExportExcel" />
				<IconButton Icon="IconType.Pdf" Variant="ButtonVariant.Pdf" Title="Export to PDF (Ctrl + P)"
							Disabled="_isProcessing" OnClick="ExportPdf" />
				<IconButton Icon="IconType.Refresh" Title="Refresh Data (Ctrl + R)" Disabled="_isProcessing"
							OnClick="LoadBalanceSheet" />
				<IconButton Icon="IconType.Report" Title="Ledger Report (Ctrl + I)" Disabled="_isProcessing"
							OnClick="NavigateToLedgerReport" />
				<IconButton Icon="IconType.TrialBalance" Title="Trial Balance (Ctrl + T)" Disabled="_isProcessing"
							OnClick="NavigateToTrialBalance" />
				<IconButton Icon="IconType.ProfitAndLoss" Title="Profit & Loss (Alt + F)" Disabled="_isProcessing"
							OnClick="NavigateToProfitAndLoss" />
				<IconButton Icon="IconType.New" Title="New Transaction (Ctrl + N)" Disabled="_isProcessing"
							OnClick="NavigateToTransactionPage" />
			</RightContent>
		</Header>

		<!-- Main Content Container -->
		<div class="page-container">

			<!-- Filters Section -->
			<div class="section-card">
				<div class="section-header">
					<div class="section-title-wrapper">
						<svg class="section-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
							 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
							 stroke-linejoin="round">
							<polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" />
						</svg>
						<h2 class="section-title">Filters</h2>
					</div>
				</div>
				<div class="section-body">
					<div class="filters-container">
						<div class="filters-grid">
							<!-- Date Range -->
							<div class="form-field">
								<label class="field-label">Date Range</label>
								<SfDateRangePicker CssClass="custom-daterange" StartDate="_fromDate" EndDate="_toDate"
												   TValue="DateTime" Format="dd/MM/yyyy" AllowEdit="true" Placeholder="Select date range">
									<DateRangePickerEvents TValue="DateTime" ValueChange="OnDateRangeChanged" />
								</SfDateRangePicker>
							</div>

							<!-- Company -->
							<div class="form-field">
								<label class="field-label">Company</label>
								<SfAutoComplete CssClass="custom-autocomplete" Value="@_selectedCompany"
												TValue="CompanyModel" TItem="CompanyModel" DataSource="@_companies"
												Placeholder="All Companies" AllowFiltering="true"
												FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains">
									<AutoCompleteEvents TItem="CompanyModel" TValue="CompanyModel"
														ValueChange="OnCompanyChanged" />
									<AutoCompleteFieldSettings Value="Name" />
								</SfAutoComplete>
							</div>
						</div>

						<!-- Date Utility Buttons -->
						<DateRangeButtons Disabled="_isProcessing" FromDate="_fromDate" ToDate="_toDate"
										  OnDatesChanged="HandleDatesChanged" ToastNotification="_toastNotification" />
					</div>
				</div>
			</div>

			<!-- Report Grid Section -->
			<div class="section-card">
				<div class="section-header">
					<div class="section-title-wrapper">
						<svg class="section-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
							 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
							 stroke-linejoin="round">
							<rect x="2" y="3" width="20" height="14" rx="2" ry="2" />
							<line x1="8" y1="21" x2="16" y2="21" />
							<line x1="12" y1="17" x2="12" y2="21" />
						</svg>
						<h2 class="section-title">Balance Sheet Statement</h2>
					</div>
					<div class="header-actions">
						<ToggleButton Disabled="@_isProcessing" IsActive="@_showAllColumns"
									  Variant="ToggleButton.ToggleVariant.Details" OnToggle="ToggleDetailsView" />
					</div>
				</div>
				<div class="section-body grid-body">
					<div class="dual-grid-container">
						<!-- Assets Grid -->
						<div class="grid-section assets-section">
							<div class="grid-section-header">
								<svg class="grid-section-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18"
									 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
									 stroke-linecap="round" stroke-linejoin="round">
									<rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
									<line x1="3" y1="9" x2="21" y2="9" />
									<line x1="9" y1="21" x2="9" y2="9" />
								</svg>
								<h3 class="grid-section-title">Assets</h3>
								<span class="grid-section-count">(@_assetsTrialBalance.Count ledgers)</span>
							</div>
							<SfGrid @ref="_assetsGrid" TValue="TrialBalanceModel" DataSource="_assetsTrialBalance"
									AllowTextWrap="true" AllowPaging="true" AllowSorting="true" AllowResizing="true"
									AllowFiltering="true" AllowExcelExport="true" AllowPdfExport="true"
									GridLines="GridLine.Horizontal" AllowGrouping="true" CssClass="professional-grid"
									Toolbar="@(new List<string>() { "Search" })">

								<GridGroupSettings ShowDropArea="true" ShowGroupedColumn="true" ShowUngroupButton="true" />
								<GridPageSettings PageSize="20"
												  PageSizes="@(new string[] { "10", "20", "50", "100", "All" })" />
								<GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Excel" />

								<GridAggregates>
									<GridAggregate>
										<GridAggregateColumns>
											<GridAggregateColumn Field="@nameof(TrialBalanceModel.LedgerName)"
																 Type="AggregateType.Count">
												<FooterTemplate>
													@{
														var aggregate = (context as AggregateTemplateContext);
													}
													<div class="aggregate-label">
														<strong>Total: @aggregate.Count</strong>
													</div>
												</FooterTemplate>
											</GridAggregateColumn>
											<GridAggregateColumn Field="@nameof(TrialBalanceModel.OpeningBalance)"
																 Type="AggregateType.Sum" Format="N2">
												<FooterTemplate>
													@{
														var aggregate = (context as AggregateTemplateContext);
														<div class="aggregate-value aggregate-debit">
															<strong>@aggregate.Sum</strong>
														</div>
													}
												</FooterTemplate>
											</GridAggregateColumn>
											<GridAggregateColumn Field="@nameof(TrialBalanceModel.Debit)"
																 Type="AggregateType.Sum" Format="N2">
												<FooterTemplate>
													@{
														var aggregate = (context as AggregateTemplateContext);
														<div class="aggregate-value aggregate-debit">
															<strong>@aggregate.Sum</strong>
														</div>
													}
												</FooterTemplate>
											</GridAggregateColumn>
											<GridAggregateColumn Field="@nameof(TrialBalanceModel.ClosingBalance)"
																 Type="AggregateType.Sum" Format="N2">
												<FooterTemplate>
													@{
														var aggregate = (context as AggregateTemplateContext);
														<div class="aggregate-value aggregate-debit">
															<strong>@aggregate.Sum</strong>
														</div>
													}
												</FooterTemplate>
											</GridAggregateColumn>
										</GridAggregateColumns>
									</GridAggregate>
								</GridAggregates>

								<GridColumns>
									<GridColumn Field="@nameof(TrialBalanceModel.LedgerName)" HeaderText="Ledger Name"
												Width="250" />
									<GridColumn Field="@nameof(TrialBalanceModel.GroupName)" HeaderText="Group" Width="150"
												Visible="_showAllColumns" />
									<GridColumn Field="@nameof(TrialBalanceModel.OpeningBalance)"
												HeaderText="Opening Balance" Width="140" TextAlign="TextAlign.Right"
												Visible="_showAllColumns">
										<Template>
											@{
												var item = (context as TrialBalanceModel);
												<span class="grid-debit">@item.OpeningBalance.ToString("N2")</span>
											}
										</Template>
									</GridColumn>
									<GridColumn Field="@nameof(TrialBalanceModel.Debit)" HeaderText="Period Debit"
												Width="140" TextAlign="TextAlign.Right" Visible="_showAllColumns">
										<Template>
											@{
												var item = (context as TrialBalanceModel);
												<span class="grid-debit">@item.Debit.ToString("N2")</span>
											}
										</Template>
									</GridColumn>
									<GridColumn Field="@nameof(TrialBalanceModel.ClosingBalance)"
												HeaderText="Closing Balance" Width="140" TextAlign="TextAlign.Right">
										<Template>
											@{
												var item = (context as TrialBalanceModel);
												<span class="grid-debit">@item.ClosingBalance.ToString("N2")</span>
											}
										</Template>
									</GridColumn>
								</GridColumns>
							</SfGrid>
						</div>

						<!-- Liabilities Grid -->
						<div class="grid-section liabilities-section">
							<div class="grid-section-header">
								<svg class="grid-section-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18"
									 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
									 stroke-linecap="round" stroke-linejoin="round">
									<path
									d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
									<polyline points="7.5 4.21 12 6.81 16.5 4.21" />
									<polyline points="7.5 19.79 7.5 14.6 3 12" />
									<polyline points="21 12 16.5 14.6 16.5 19.79" />
									<polyline points="3.27 6.96 12 12.01 20.73 6.96" />
									<line x1="12" y1="22.08" x2="12" y2="12" />
								</svg>
								<h3 class="grid-section-title">Liabilities</h3>
								<span class="grid-section-count">(@_liabilitiesTrialBalance.Count ledgers)</span>
							</div>
							<SfGrid @ref="_liabilitiesGrid" TValue="TrialBalanceModel" DataSource="_liabilitiesTrialBalance"
									AllowTextWrap="true" AllowPaging="true" AllowSorting="true" AllowResizing="true"
									AllowFiltering="true" AllowExcelExport="true" AllowPdfExport="true"
									GridLines="GridLine.Horizontal" AllowGrouping="true" CssClass="professional-grid"
									Toolbar="@(new List<string>() { "Search" })">

								<GridGroupSettings ShowDropArea="true" ShowGroupedColumn="true" ShowUngroupButton="true" />
								<GridPageSettings PageSize="20"
												  PageSizes="@(new string[] { "10", "20", "50", "100", "All" })" />
								<GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Excel" />

								<GridAggregates>
									<GridAggregate>
										<GridAggregateColumns>
											<GridAggregateColumn Field="@nameof(TrialBalanceModel.LedgerName)"
																 Type="AggregateType.Count">
												<FooterTemplate>
													@{
														var aggregate = (context as AggregateTemplateContext);
													}
													<div class="aggregate-label">
														<strong>Total: @aggregate.Count</strong>
													</div>
												</FooterTemplate>
											</GridAggregateColumn>
											<GridAggregateColumn Field="@nameof(TrialBalanceModel.OpeningBalance)"
																 Type="AggregateType.Sum" Format="N2">
												<FooterTemplate>
													@{
														var aggregate = (context as AggregateTemplateContext);
														<div class="aggregate-value aggregate-credit">
															<strong>@aggregate.Sum</strong>
														</div>
													}
												</FooterTemplate>
											</GridAggregateColumn>
											<GridAggregateColumn Field="@nameof(TrialBalanceModel.Credit)"
																 Type="AggregateType.Sum" Format="N2">
												<FooterTemplate>
													@{
														var aggregate = (context as AggregateTemplateContext);
														<div class="aggregate-value aggregate-credit">
															<strong>@aggregate.Sum</strong>
														</div>
													}
												</FooterTemplate>
											</GridAggregateColumn>
											<GridAggregateColumn Field="@nameof(TrialBalanceModel.ClosingBalance)"
																 Type="AggregateType.Sum" Format="N2">
												<FooterTemplate>
													@{
														var aggregate = (context as AggregateTemplateContext);
														<div class="aggregate-value aggregate-credit">
															<strong>@aggregate.Sum</strong>
														</div>
													}
												</FooterTemplate>
											</GridAggregateColumn>
										</GridAggregateColumns>
									</GridAggregate>
								</GridAggregates>

								<GridColumns>
									<GridColumn Field="@nameof(TrialBalanceModel.LedgerName)" HeaderText="Ledger Name"
												Width="250" />
									<GridColumn Field="@nameof(TrialBalanceModel.GroupName)" HeaderText="Group" Width="150"
												Visible="_showAllColumns" />
									<GridColumn Field="@nameof(TrialBalanceModel.OpeningBalance)"
												HeaderText="Opening Balance" Width="140" TextAlign="TextAlign.Right"
												Visible="_showAllColumns">
										<Template>
											@{
												var item = (context as TrialBalanceModel);
												<span class="grid-credit">@item.OpeningBalance.ToString("N2")</span>
											}
										</Template>
									</GridColumn>
									<GridColumn Field="@nameof(TrialBalanceModel.Credit)" HeaderText="Period Credit"
												Width="140" TextAlign="TextAlign.Right" Visible="_showAllColumns">
										<Template>
											@{
												var item = (context as TrialBalanceModel);
												<span class="grid-credit">@item.Credit.ToString("N2")</span>
											}
										</Template>
									</GridColumn>
									<GridColumn Field="@nameof(TrialBalanceModel.ClosingBalance)"
												HeaderText="Closing Balance" Width="140" TextAlign="TextAlign.Right">
										<Template>
											@{
												var item = (context as TrialBalanceModel);
												<span class="grid-credit">@item.ClosingBalance.ToString("N2")</span>
											}
										</Template>
									</GridColumn>
								</GridColumns>
							</SfGrid>
						</div>
					</div>
				</div>
			</div>

			<!-- Summary Section -->
			<div class="section-card balance-sheet-summary">
				<div class="section-header">
					<div class="section-title-wrapper">
						<svg class="section-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
							 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
							 stroke-linejoin="round">
							<rect x="2" y="3" width="20" height="14" rx="2" ry="2" />
							<line x1="8" y1="21" x2="16" y2="21" />
							<line x1="12" y1="17" x2="12" y2="21" />
							<line x1="7" y1="7" x2="7" y2="11" />
							<line x1="12" y1="7" x2="12" y2="11" />
							<line x1="17" y1="7" x2="17" y2="11" />
						</svg>
						<h2 class="section-title">Balance Sheet Summary</h2>
					</div>
				</div>
				<div class="section-body">
					<div class="balance-sheet-grid">
						@{
							var totalAssets = _assetsTrialBalance.Sum(x => x.ClosingBalance);
							var totalLiabilities = _liabilitiesTrialBalance.Sum(x => x.ClosingBalance);
							var netPosition = totalAssets - totalLiabilities;
							var isPositive = netPosition >= 0;
						}

						<!-- Total Assets Card -->
						<BalanceInfoCard Label="Total Assets" Value="@($"₹{totalAssets:N2}")"
										 Breakdown="@($"{_assetsTrialBalance.Count} ledgers")"
										 Variant="BalanceInfoCard.CardVariant.Assets">
							<Icon>
								<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
									 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
									 stroke-linejoin="round">
									<rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
									<line x1="3" y1="9" x2="21" y2="9" />
									<line x1="9" y1="21" x2="9" y2="9" />
								</svg>
							</Icon>
						</BalanceInfoCard>

						<!-- Total Liabilities Card -->
						<BalanceInfoCard Label="Total Liabilities" Value="@($"₹{totalLiabilities:N2}")"
										 Breakdown="@($"{_liabilitiesTrialBalance.Count} ledgers")"
										 Variant="BalanceInfoCard.CardVariant.Liabilities">
							<Icon>
								<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
									 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
									 stroke-linejoin="round">
									<path
									d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
								</svg>
							</Icon>
						</BalanceInfoCard>

						<!-- Net Position Card -->
						<BalanceInfoCard Label="@(isPositive ? "Net Position" : "Net Deficit")"
										 Value="@($"₹{Math.Abs(netPosition):N2}")"
										 Breakdown="@(totalAssets > 0 ? $"Ratio: {((netPosition / totalAssets) * 100):N2}%" : "")"
										 Variant="@(isPositive? BalanceInfoCard.CardVariant.Positive : BalanceInfoCard.CardVariant.Negative)">
							<Icon>
								@if (isPositive)
								{
									<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
										 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
										 stroke-linejoin="round">
										<line x1="12" y1="1" x2="12" y2="23" />
										<path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
									</svg>
								}
								else
								{
									<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
										 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
										 stroke-linejoin="round">
										<circle cx="12" cy="12" r="10" />
										<line x1="15" y1="9" x2="9" y2="15" />
										<line x1="9" y1="9" x2="15" y2="15" />
									</svg>
								}
							</Icon>
						</BalanceInfoCard>
					</div>
				</div>
			</div>
		</div>

		<Footer />
	</div>
}

<ToastNotification @ref="_toastNotification" />

<style>
	.dual-grid-container {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: 24px;
		padding: 24px;
	}

	/* Balance Sheet Section Colors */
	.assets-section .grid-section-icon {
		color: #0891b2;
	}

	.liabilities-section .grid-section-icon {
		color: #6366f1;
	}

	/* Balance Sheet Summary Section */
	.balance-sheet-summary {
		background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
	}

	.balance-sheet-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
		gap: 14px;
	}
</style>