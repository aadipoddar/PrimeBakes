@attribute [Route(PageRouteNames.ProfitAndLossReport)]

@using PrimeBakesLibrary.Models.Accounts.FinancialAccounting
@using PrimeBakesLibrary.Models.Accounts.Masters
@using PrimeBakesLibrary.Models.Operations

<PageTitle>Profit & Loss - Prime Bakes</PageTitle>

@if (_isLoading)
{
	<AnimatedLoader Visible="true" />
}
else
{
	<div style="display: flex; flex-direction: column; min-height: 100vh;">
		<Header Title="Profit & Loss" Subtitle="View profit & loss for specified period" ShowHome="true" ShowBack="true"
				ShowLogout="true" OnHomeClick="NavigateToDashboard" OnBackClick="NavigateBack" OnLogoutClick="Logout">
			<RightContent>
				<IconButton Icon="IconType.Excel" Variant="ButtonVariant.Excel" Title="Export to Excel (Ctrl + E)"
							Disabled="_isProcessing" OnClick="ExportExcel" />
				<IconButton Icon="IconType.Pdf" Variant="ButtonVariant.Pdf" Title="Export to PDF (Ctrl + P)"
							Disabled="_isProcessing" OnClick="ExportPdf" />
				<IconButton Icon="IconType.Refresh" Title="Refresh Data (Ctrl + R)" Disabled="_isProcessing"
							OnClick="LoadProfitAndLoss" />
				<IconButton Icon="IconType.Report" Title="Ledger Report (Ctrl + I)" Disabled="_isProcessing"
							OnClick="NavigateToLedgerReport" />
				<IconButton Icon="IconType.TrialBalance" Title="Trial Balance (Ctrl + T)" Disabled="_isProcessing"
							OnClick="NavigateToTrialBalance" />
				<IconButton Icon="IconType.BalanceSheet" Title="Balance Sheet (Alt+ B)" Disabled="_isProcessing"
							OnClick="NavigateToBalanceSheet" />
				<IconButton Icon="IconType.New" Title="New Transaction (Ctrl + N)" Disabled="_isProcessing"
							OnClick="NavigateToTransactionPage" />
			</RightContent>
		</Header>

		<!-- Main Content Container -->
		<div class="page-container">

			<!-- Filters Section -->
			<div class="section-card">
				<div class="section-header">
					<div class="section-title-wrapper">
						<svg class="section-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
							 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
							 stroke-linejoin="round">
							<polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" />
						</svg>
						<h2 class="section-title">Filters</h2>
					</div>
				</div>
				<div class="section-body">
					<div class="filters-container">
						<div class="filters-grid">
							<!-- Date Range -->
							<div class="form-field">
								<label class="field-label">Date Range</label>
								<SfDateRangePicker CssClass="custom-daterange" StartDate="_fromDate" EndDate="_toDate"
												   TValue="DateTime" Format="dd/MM/yyyy" AllowEdit="true" Placeholder="Select date range">
									<DateRangePickerEvents TValue="DateTime" ValueChange="OnDateRangeChanged" />
								</SfDateRangePicker>
							</div>

							<!-- Company -->
							<div class="form-field">
								<label class="field-label">Company</label>
								<SfAutoComplete CssClass="custom-autocomplete" Value="@_selectedCompany"
												TValue="CompanyModel" TItem="CompanyModel" DataSource="@_companies"
												Placeholder="All Companies" AllowFiltering="true"
												FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains">
									<AutoCompleteEvents TItem="CompanyModel" TValue="CompanyModel"
														ValueChange="OnCompanyChanged" />
									<AutoCompleteFieldSettings Value="Name" />
								</SfAutoComplete>
							</div>
						</div>

						<!-- Date Utility Buttons -->
						<DateRangeButtons Disabled="_isProcessing" FromDate="_fromDate" ToDate="_toDate"
										  OnDatesChanged="HandleDatesChanged" ToastNotification="_toastNotification" />
					</div>
				</div>
			</div>

			<!-- Report Grid Section -->
			<div class="section-card">
				<div class="section-header">
					<div class="section-title-wrapper">
						<svg class="section-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
							 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
							 stroke-linejoin="round">
							<rect x="2" y="3" width="20" height="14" rx="2" ry="2" />
							<line x1="8" y1="21" x2="16" y2="21" />
							<line x1="12" y1="17" x2="12" y2="21" />
						</svg>
						<h2 class="section-title">Profit & Loss Statement</h2>
					</div>
					<div class="header-actions">
						<ToggleButton Disabled="@_isProcessing" IsActive="@_showAllColumns"
									  Variant="ToggleButton.ToggleVariant.Details" OnToggle="ToggleDetailsView" />
					</div>
				</div>
				<div class="section-body grid-body">
					<div class="dual-grid-container">
						<!-- Income Grid -->
						<div class="grid-section income-section">
							<div class="grid-section-header">
								<svg class="grid-section-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18"
									 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
									 stroke-linecap="round" stroke-linejoin="round">
									<polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />
									<polyline points="17 6 23 6 23 12" />
								</svg>
								<h3 class="grid-section-title">Income</h3>
								<span class="grid-section-count">(@_incomeTrialBalance.Count ledgers)</span>
							</div>
							<SfGrid @ref="_incomeGrid" TValue="TrialBalanceModel" DataSource="_incomeTrialBalance"
									AllowTextWrap="true" AllowPaging="true" AllowSorting="true" AllowResizing="true"
									AllowFiltering="true" AllowExcelExport="true" AllowPdfExport="true"
									GridLines="GridLine.Horizontal" AllowGrouping="true" CssClass="professional-grid"
									Toolbar="@(new List<string>() { "Search" })">

								<GridGroupSettings ShowDropArea="true" ShowGroupedColumn="true" ShowUngroupButton="true" />
								<GridPageSettings PageSize="20"
												  PageSizes="@(new string[] { "10", "20", "50", "100", "All" })" />
								<GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Excel" />

								<GridAggregates>
									<GridAggregate>
										<GridAggregateColumns>
											<GridAggregateColumn Field="@nameof(TrialBalanceModel.LedgerName)"
																 Type="AggregateType.Count">
												<FooterTemplate>
													@{
														var aggregate = (context as AggregateTemplateContext);
													}
													<div class="aggregate-label">
														<strong>Total: @aggregate.Count</strong>
													</div>
												</FooterTemplate>
											</GridAggregateColumn>
											<GridAggregateColumn Field="@nameof(TrialBalanceModel.OpeningBalance)"
																 Type="AggregateType.Sum" Format="N2">
												<FooterTemplate>
													@{
														var aggregate = (context as AggregateTemplateContext);
														<div class="aggregate-value aggregate-credit">
															<strong>@aggregate.Sum</strong>
														</div>
													}
												</FooterTemplate>
											</GridAggregateColumn>
											<GridAggregateColumn Field="@nameof(TrialBalanceModel.Credit)"
																 Type="AggregateType.Sum" Format="N2">
												<FooterTemplate>
													@{
														var aggregate = (context as AggregateTemplateContext);
														<div class="aggregate-value aggregate-credit">
															<strong>@aggregate.Sum</strong>
														</div>
													}
												</FooterTemplate>
											</GridAggregateColumn>
											<GridAggregateColumn Field="@nameof(TrialBalanceModel.ClosingBalance)"
																 Type="AggregateType.Sum" Format="N2">
												<FooterTemplate>
													@{
														var aggregate = (context as AggregateTemplateContext);
														<div class="aggregate-value aggregate-credit">
															<strong>@aggregate.Sum</strong>
														</div>
													}
												</FooterTemplate>
											</GridAggregateColumn>
										</GridAggregateColumns>
									</GridAggregate>
								</GridAggregates>

								<GridColumns>
									<GridColumn Field="@nameof(TrialBalanceModel.LedgerName)" HeaderText="Ledger Name"
												Width="250" />
									<GridColumn Field="@nameof(TrialBalanceModel.GroupName)" HeaderText="Group" Width="150"
												Visible="_showAllColumns" />
									<GridColumn Field="@nameof(TrialBalanceModel.OpeningBalance)"
												HeaderText="Opening Balance" Width="140" TextAlign="TextAlign.Right"
												Visible="_showAllColumns">
										<Template>
											@{
												var item = (context as TrialBalanceModel);
												<span class="grid-credit">@item.OpeningBalance.ToString("N2")</span>
											}
										</Template>
									</GridColumn>
									<GridColumn Field="@nameof(TrialBalanceModel.Credit)" HeaderText="Period Credit"
												Width="140" TextAlign="TextAlign.Right" Visible="_showAllColumns">
										<Template>
											@{
												var item = (context as TrialBalanceModel);
												<span class="grid-credit">@item.Credit.ToString("N2")</span>
											}
										</Template>
									</GridColumn>
									<GridColumn Field="@nameof(TrialBalanceModel.ClosingBalance)"
												HeaderText="Closing Balance" Width="140" TextAlign="TextAlign.Right">
										<Template>
											@{
												var item = (context as TrialBalanceModel);
												<span class="grid-credit">@item.ClosingBalance.ToString("N2")</span>
											}
										</Template>
									</GridColumn>
								</GridColumns>
							</SfGrid>
						</div>

						<!-- Expense Grid -->
						<div class="grid-section expense-section">
							<div class="grid-section-header">
								<svg class="grid-section-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18"
									 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
									 stroke-linecap="round" stroke-linejoin="round">
									<polyline points="23 18 13.5 8.5 8.5 13.5 1 6" />
									<polyline points="17 18 23 18 23 12" />
								</svg>
								<h3 class="grid-section-title">Expenses</h3>
								<span class="grid-section-count">(@_expenseTrialBalance.Count ledgers)</span>
							</div>
							<SfGrid @ref="_expenseGrid" TValue="TrialBalanceModel" DataSource="_expenseTrialBalance"
									AllowTextWrap="true" AllowPaging="true" AllowSorting="true" AllowResizing="true"
									AllowFiltering="true" AllowExcelExport="true" AllowPdfExport="true"
									GridLines="GridLine.Horizontal" AllowGrouping="true" CssClass="professional-grid"
									Toolbar="@(new List<string>() { "Search" })">

								<GridGroupSettings ShowDropArea="true" ShowGroupedColumn="true" ShowUngroupButton="true" />
								<GridPageSettings PageSize="20"
												  PageSizes="@(new string[] { "10", "20", "50", "100", "All" })" />
								<GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Excel" />

								<GridAggregates>
									<GridAggregate>
										<GridAggregateColumns>
											<GridAggregateColumn Field="@nameof(TrialBalanceModel.LedgerName)"
																 Type="AggregateType.Count">
												<FooterTemplate>
													@{
														var aggregate = (context as AggregateTemplateContext);
													}
													<div class="aggregate-label">
														<strong>Total: @aggregate.Count</strong>
													</div>
												</FooterTemplate>
											</GridAggregateColumn>
											<GridAggregateColumn Field="@nameof(TrialBalanceModel.OpeningBalance)"
																 Type="AggregateType.Sum" Format="N2">
												<FooterTemplate>
													@{
														var aggregate = (context as AggregateTemplateContext);
														<div class="aggregate-value aggregate-debit">
															<strong>@aggregate.Sum</strong>
														</div>
													}
												</FooterTemplate>
											</GridAggregateColumn>
											<GridAggregateColumn Field="@nameof(TrialBalanceModel.Debit)"
																 Type="AggregateType.Sum" Format="N2">
												<FooterTemplate>
													@{
														var aggregate = (context as AggregateTemplateContext);
														<div class="aggregate-value aggregate-debit">
															<strong>@aggregate.Sum</strong>
														</div>
													}
												</FooterTemplate>
											</GridAggregateColumn>
											<GridAggregateColumn Field="@nameof(TrialBalanceModel.ClosingBalance)"
																 Type="AggregateType.Sum" Format="N2">
												<FooterTemplate>
													@{
														var aggregate = (context as AggregateTemplateContext);
														<div class="aggregate-value aggregate-debit">
															<strong>@aggregate.Sum</strong>
														</div>
													}
												</FooterTemplate>
											</GridAggregateColumn>
										</GridAggregateColumns>
									</GridAggregate>
								</GridAggregates>

								<GridColumns>
									<GridColumn Field="@nameof(TrialBalanceModel.LedgerName)" HeaderText="Ledger Name"
												Width="250" />
									<GridColumn Field="@nameof(TrialBalanceModel.GroupName)" HeaderText="Group" Width="150"
												Visible="_showAllColumns" />
									<GridColumn Field="@nameof(TrialBalanceModel.OpeningBalance)"
												HeaderText="Opening Balance" Width="140" TextAlign="TextAlign.Right"
												Visible="_showAllColumns">
										<Template>
											@{
												var item = (context as TrialBalanceModel);
												<span class="grid-debit">@item.OpeningBalance.ToString("N2")</span>
											}
										</Template>
									</GridColumn>
									<GridColumn Field="@nameof(TrialBalanceModel.Debit)" HeaderText="Period Debit"
												Width="140" TextAlign="TextAlign.Right" Visible="_showAllColumns">
										<Template>
											@{
												var item = (context as TrialBalanceModel);
												<span class="grid-debit">@item.Debit.ToString("N2")</span>
											}
										</Template>
									</GridColumn>
									<GridColumn Field="@nameof(TrialBalanceModel.ClosingBalance)"
												HeaderText="Closing Balance" Width="140" TextAlign="TextAlign.Right">
										<Template>
											@{
												var item = (context as TrialBalanceModel);
												<span class="grid-debit">@item.ClosingBalance.ToString("N2")</span>
											}
										</Template>
									</GridColumn>
								</GridColumns>
							</SfGrid>
						</div>
					</div>
				</div>
			</div>

			<!-- Summary Section -->
			<div class="section-card profit-loss-summary">
				<div class="section-header">
					<div class="section-title-wrapper">
						<svg class="section-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
							 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
							 stroke-linejoin="round">
							<rect x="2" y="3" width="20" height="14" rx="2" ry="2" />
							<line x1="8" y1="21" x2="16" y2="21" />
							<line x1="12" y1="17" x2="12" y2="21" />
							<line x1="7" y1="7" x2="7" y2="11" />
							<line x1="12" y1="7" x2="12" y2="11" />
							<line x1="17" y1="7" x2="17" y2="11" />
						</svg>
						<h2 class="section-title">Profit & Loss Summary</h2>
					</div>
				</div>
				<div class="section-body">
					<div class="profit-loss-grid">
						@{
							var totalIncome = _incomeTrialBalance.Sum(x => x.ClosingBalance);
							var totalExpense = _expenseTrialBalance.Sum(x => x.ClosingBalance);
							var profitLoss = totalIncome - totalExpense;
							var isProfitable = profitLoss >= 0;
						}

						<!-- Total Income Card -->
						<BalanceInfoCard Label="Total Income" Value="@($"₹{totalIncome:N2}")"
										 Breakdown="@($"{_incomeTrialBalance.Count} ledgers")"
										 Variant="BalanceInfoCard.CardVariant.Income">
							<Icon>
								<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
									 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
									 stroke-linejoin="round">
									<line x1="12" y1="19" x2="12" y2="5" />
									<polyline points="5 12 12 5 19 12" />
								</svg>
							</Icon>
						</BalanceInfoCard>

						<!-- Total Expenses Card -->
						<BalanceInfoCard Label="Total Expenses" Value="@($"₹{totalExpense:N2}")"
										 Breakdown="@($"{_expenseTrialBalance.Count} ledgers")"
										 Variant="BalanceInfoCard.CardVariant.Expense">
							<Icon>
								<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
									 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
									 stroke-linejoin="round">
									<line x1="12" y1="5" x2="12" y2="19" />
									<polyline points="19 12 12 19 5 12" />
								</svg>
							</Icon>
						</BalanceInfoCard>

						<!-- Net Profit/Loss Card -->
						<BalanceInfoCard Label="@(isProfitable ? "Net Profit" : "Net Loss")"
										 Value="@($"₹{Math.Abs(profitLoss):N2}")"
										 Breakdown="@(totalIncome > 0 ? $"Margin: {((profitLoss / totalIncome) * 100):N2}%" : "")"
										 Variant="@(isProfitable ? BalanceInfoCard.CardVariant.Profit : BalanceInfoCard.CardVariant.Loss)">
							<Icon>
								@if (isProfitable)
								{
									<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
										 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
										 stroke-linejoin="round">
										<polyline points="20 6 9 17 4 12" />
									</svg>
								}
								else
								{
									<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
										 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
										 stroke-linejoin="round">
										<line x1="18" y1="6" x2="6" y2="18" />
										<line x1="6" y1="6" x2="18" y2="18" />
									</svg>
								}
							</Icon>
						</BalanceInfoCard>
					</div>
				</div>
			</div>
		</div>

		<Footer />
	</div>
}

<ToastNotification @ref="_toastNotification" />

<style>
	.dual-grid-container {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: 24px;
		padding: 24px;
	}

	/* P&L Section Colors */
	.income-section .grid-section-icon {
		color: #059669;
	}

	.expense-section .grid-section-icon {
		color: #dc2626;
	}

	/* Profit & Loss Summary Section */
	.profit-loss-summary {
		background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
	}

	.profit-loss-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
		gap: 14px;
	}
</style>