@attribute [Route(PageRouteNames.Order)]
@attribute [Route(PageRouteNames.Order + "/{Id:int}")]

@using PrimeBakesLibrary.Models.Accounts.Masters
@using PrimeBakesLibrary.Models.Operations
@using PrimeBakesLibrary.Models.Store.Product
@using PrimeBakesLibrary.Models.Store.Order
@using PrimeBakesLibrary.Models.Store.Sale

<PageTitle>Order - PrimeBakes</PageTitle>

@if (_isLoading)
{
    <AnimatedLoader Visible="true" />
}
else
{
    <div style="display: flex; flex-direction: column; min-height: 100vh;">
        <Header Title="Create Order" Subtitle="Create and manage order transactions" ShowLogout="true" ShowHome="true"
                ShowBack="true" OnHomeClick="NavigateToDashboard" OnBackClick="NavigateBack" OnLogoutClick="Logout">
            <RightContent>
                <IconButton Icon="IconType.Save" Variant="ButtonVariant.Save" Title="Save Transaction (Ctrl + S)"
                            Disabled="_isProcessing" OnClick="SaveTransaction" />
                @if (Id is > 0)
                {
                    <IconButton Icon="IconType.Excel" Variant="ButtonVariant.Excel" Title="Download Excel Invoice (Alt+E)"
                                Disabled="_isProcessing" OnClick="DownloadExcelInvoice" />
                    <IconButton Icon="IconType.Pdf" Variant="ButtonVariant.Pdf" Title="Download PDF Invoice (Alt+P)"
                                Disabled="_isProcessing" OnClick="DownloadPdfInvoice" />
                }
                <IconButton Icon="IconType.History" Title="Transaction History (Ctrl + H)" Disabled="_isProcessing"
                            OnClick="NavigateToTransactionHistoryPage" />
                <IconButton Icon="IconType.Report" Title="Item Report (Ctrl + I)" Disabled="_isProcessing"
                            OnClick="NavigateToItemReport" />
                <IconButton Icon="IconType.New" Title="New Transaction (Ctrl + N)" Disabled="_isProcessing"
                            OnClick="ResetPage" />
            </RightContent>
        </Header>

        <!-- Main Content Container -->
        <div class="page-container">

            <!-- Transaction Summary Section -->
            <div class="section-card">
                <div class="section-header">
                    <div class="section-title-wrapper">
                        <svg class="section-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                             viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                             stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                            <polyline points="14 2 14 8 20 8" />
                            <line x1="16" y1="13" x2="8" y2="13" />
                            <line x1="16" y1="17" x2="8" y2="17" />
                            <polyline points="10 9 9 9 8 9" />
                        </svg>
                        <h2 class="section-title">Transaction Summary</h2>
                    </div>
                </div>
                <div class="section-body">
                    <div class="form-grid">
                        @if (_user.LocationId == 1)
                        {
                            <div class="form-field">
                                <label class="field-label">
                                    Location <span class="required">*</span>
                                </label>
                                <SfAutoComplete Value="@_selectedLocation" TValue="LocationModel" TItem="LocationModel"
                                                DataSource="@_locations" Placeholder="Select a Location"
                                                FloatLabelType="FloatLabelType.Never" AllowFiltering="true"
                                                FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains"
                                                CssClass="custom-autocomplete">
                                    <AutoCompleteEvents TItem="LocationModel" TValue="LocationModel"
                                                        ValueChange="OnLocationChanged" />
                                    <AutoCompleteFieldSettings Value="Name" />
                                </SfAutoComplete>
                            </div>

                            <div class="form-field">
                                <label class="field-label">
                                    Company <span class="required">*</span>
                                </label>
                                <SfAutoComplete Value="@_selectedCompany" TValue="CompanyModel" TItem="CompanyModel"
                                                DataSource="@_companies" Placeholder="Select a Company"
                                                FloatLabelType="FloatLabelType.Never" AllowFiltering="true"
                                                FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains"
                                                CssClass="custom-autocomplete">
                                    <AutoCompleteEvents TItem="CompanyModel" TValue="CompanyModel"
                                                        ValueChange="OnCompanyChanged" />
                                    <AutoCompleteFieldSettings Value="Name" />
                                </SfAutoComplete>
                            </div>

                            <div class="form-field">
                                <label class="field-label">
                                    Transaction Date <span class="required">*</span> / Financial Year
                                </label>
                                <div class="date-year-wrapper">
                                    <SfDatePicker Value="@_order.TransactionDateTime" TValue="DateTime" Format="dd/MM/yy"
                                                  Placeholder="Select Date" FloatLabelType="FloatLabelType.Never"
                                                  CssClass="custom-datepicker">
                                        <DatePickerEvents TValue="DateTime" ValueChange="OnTransactionDateChanged" />
                                    </SfDatePicker>
                                    <SfTextBox Value="@($"{_selectedFinancialYear?.StartDate:yyyy} to {_selectedFinancialYear?.EndDate:yyyy}")"
                                               Readonly="true" Placeholder="Financial Year" FloatLabelType="FloatLabelType.Never"
                                               CssClass="custom-textbox readonly-field" />
                                </div>
                            </div>
                        }

                            <div class="form-field">
                                <label class="field-label">
                                    Transaction No <span class="required">*</span>
                                </label>
                                <SfTextBox @bind-Value="_order.TransactionNo" Placeholder="Transaction No"
                                           FloatLabelType="FloatLabelType.Never" Readonly="true"
                                           CssClass="custom-textbox readonly-field" />
                            </div>

                        @if (_sale?.Id > 0)
                        {
                            <div class="form-field">
                                <label class="field-label">
                                    Linked Sale
                                </label>
                                <div class="reference-wrapper">
                                    <SfTextBox Value="@_sale.TransactionNo" Readonly="true" Placeholder="No Sale Linked"
                                               FloatLabelType="FloatLabelType.Never" CssClass="custom-textbox readonly-field" />
                                    <div class="reference-actions">
                                        <IconButton Icon="IconType.View" Variant="ButtonVariant.View"
                                                    Size="ButtonSize.Small" Title="View Sale"
                                                    OnClick="NavigateToSelectedSalePage" />
                                        <IconButton Icon="IconType.Excel" Variant="ButtonVariant.Excel"
                                                    Size="ButtonSize.Small" Title="Download Excel Invoice"
                                                    OnClick="DownloadSelectedSaleExcel" />
                                        <IconButton Icon="IconType.Pdf" Variant="ButtonVariant.Pdf" Size="ButtonSize.Small"
                                                    Title="Download PDF Invoice" OnClick="DownloadSelectedSalePdf" />
                                    </div>
                                </div>
                            </div>
                        }

                        <div class="form-field">
                            <label class="field-label">
                                Remarks / Narration
                            </label>
                            <SfTextBox @bind-Value="_order.Remarks" Multiline="true" Placeholder="Enter remarks..."
                                       FloatLabelType="FloatLabelType.Never" CssClass="custom-textbox" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add to Cart Section -->
            <div class="section-card">
                <div class="section-header">
                    <div class="section-title-wrapper">
                        <svg class="section-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                             viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                             stroke-linejoin="round">
                            <circle cx="9" cy="21" r="1" />
                            <circle cx="20" cy="21" r="1" />
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
                        </svg>
                        <h2 class="section-title">Add Item to Cart</h2>
                    </div>
                </div>
                <div class="section-body">
                    <div class="cart-input-row">
                        <div class="cart-field cart-field-wide">
                            <label class="cart-label">Item <span class="required">*</span></label>
                            <SfAutoComplete @ref="_sfItemAutoComplete" Value="@_selectedProduct"
                                            TValue="ProductLocationOverviewModel" TItem="ProductLocationOverviewModel"
                                            DataSource="@_products" Placeholder="Select Item (Ctrl + E)"
                                            FloatLabelType="FloatLabelType.Never" AllowFiltering="true"
                                            FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains" CssClass="custom-autocomplete">
                                <AutoCompleteEvents TItem="ProductLocationOverviewModel"
                                                    TValue="ProductLocationOverviewModel" ValueChange="OnItemChanged" />
                                <AutoCompleteFieldSettings Value="Name" />
                            </SfAutoComplete>
                        </div>

                        <div class="cart-field">
                            <label class="cart-label">Qty <span class="required">*</span></label>
                            <SfNumericTextBox Value="@_selectedCart.Quantity" TValue="decimal" Min="0"
                                              ShowSpinButton="false" Placeholder="0.00" FloatLabelType="FloatLabelType.Never"
                                              CssClass="custom-numeric">
                                <NumericTextBoxEvents TValue="decimal" ValueChange="OnItemQuantityChanged" />
                            </SfNumericTextBox>
                        </div>

                        <div class="cart-field cart-field-wide">
                            <label class="cart-label">Remarks</label>
                            <SfTextBox @bind-Value="_selectedCart.Remarks" Placeholder="Item Narration..."
                                       FloatLabelType="FloatLabelType.Never" CssClass="custom-textbox" />
                        </div>

                        <div class="cart-field">
                            <label class="cart-label">&nbsp;</label>
                            <IconButton Icon="IconType.Add" Variant="ButtonVariant.Add" Text="Add" Title="Add to Cart"
                                        OnClick="AddItemToCart" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cart Items Grid Section -->
            <div class="section-card">
                <div class="section-header">
                    <div class="section-title-wrapper">
                        <svg class="section-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                             viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                             stroke-linejoin="round">
                            <path d="M3 3h7a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H3V3z" />
                            <path d="M14 3h7v17h-7V3z" />
                        </svg>
                        <h2 class="section-title">Order Items</h2>
                    </div>
                </div>
                <div class="section-body grid-body">
                    <SfGrid ID="_sfCartGrid" @ref="_sfCartGrid" DataSource="_cart" AllowTextWrap="true" AllowPaging="false"
                            AllowSorting="true" AllowResizing="true" AllowFiltering="true" GridLines="GridLine.Horizontal"
                            CssClass="professional-grid" Toolbar="@(new List<string>() { "Search" })">

                        <GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Excel" />

                        <GridAggregates>
                            <GridAggregate>
                                <GridAggregateColumns>
                                    <GridAggregateColumn Field="ItemName" Type="AggregateType.Count">
                                        <FooterTemplate>
                                            @{
                                                var aggregate = (context as AggregateTemplateContext);
                                            }
                                            <div class="aggregate-label">
                                                <strong>Total Items: @aggregate.Count</strong>
                                            </div>
                                        </FooterTemplate>
                                    </GridAggregateColumn>
                                    <GridAggregateColumn Field="Quantity" Type="AggregateType.Sum">
                                        <FooterTemplate>
                                            @{
                                                var aggregate = (context as AggregateTemplateContext);
                                                var sum = aggregate.Sum != null ? Convert.ToDecimal(aggregate.Sum) : 0m;
                                            }
                                            <div class="aggregate-value">
                                                <strong>@sum.ToString("N2")</strong>
                                            </div>
                                        </FooterTemplate>
                                    </GridAggregateColumn>
                                </GridAggregateColumns>
                            </GridAggregate>
                        </GridAggregates>

                        <GridColumns>
                            <GridColumn HeaderText="Actions" Width="100" TextAlign="TextAlign.Center">
                                <Template>
                                    @{
                                        var item = (context as dynamic);
                                        <div class="grid-actions">
                                            <IconButton Icon="IconType.Edit" Variant="ButtonVariant.Edit" Size="ButtonSize.Grid"
                                                        Title="Edit Item (Insert)" OnClick="@(() => EditCartItem(item))" />
                                            <IconButton Icon="IconType.Delete" Variant="ButtonVariant.Delete"
                                                        Size="ButtonSize.Grid" Title="Remove Item (Del)"
                                                        OnClick="@(() => RemoveItemFromCart(item))" />
                                        </div>
                                    }
                                </Template>
                            </GridColumn>
                            <GridColumn Field="ItemName" HeaderText="Item Name" Width="300" />
                            <GridColumn Field="Quantity" HeaderText="Qty" Width="150" TextAlign="TextAlign.Right"
                                        Format="N2" />
                            <GridColumn Field="Remarks" HeaderText="Remarks" Width="200" />
                        </GridColumns>
                    </SfGrid>
                </div>
            </div>
        </div>

        <Footer />
    </div>
}

<ToastNotification @ref="_toastNotification" />