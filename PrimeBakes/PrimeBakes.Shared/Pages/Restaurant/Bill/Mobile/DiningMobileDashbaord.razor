@attribute [Route(PageRouteNames.DiningMobileDashboard)]

@using PrimeBakesLibrary.Data.Common
@using PrimeBakesLibrary.Models.Restuarant.Dining

<PageTitle>Dining Dashboard - Prime Bakes</PageTitle>

@if (_isLoading || _user is null)
{
	<AnimatedLoader Visible="true" />
}
else
{
	<div class="page-shell">
		<Header Title="Dining Dashboard"
				Subtitle="View dining tables by area"
				ShowLogout="true"
				ShowHome="true"
				ShowBack="true"
				OnLogoutClick="Logout"
				OnHomeClick="NavigateToDashboard"
				OnBackClick="NavigateBack" />

		<div class="page-container">
			@if (_diningAreas.Count == 0)
			{
				<div class="section-card">
					<div class="section-header">
						<div class="section-title-wrapper">
							<h2 class="section-title">Dining Areas</h2>
						</div>
						<p class="section-subtitle">No active dining areas found for your location</p>
					</div>
				</div>
			}
			else
			{
				@foreach (var area in _diningAreas)
				{
					var areaTables = _diningTables.Where(t => t.DiningAreaId == area.Id).OrderBy(t => t.Name).ToList();
					var runningTablesCount = areaTables.Count(t => _runningBills.Any(bill => bill.DiningTableId == t.Id));

					<div class="section-card">
						<div class="section-header">
							<div class="section-title-wrapper">
								<svg class="section-icon" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"
									 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<rect x="3" y="3" width="8" height="8" rx="1" />
									<rect x="13" y="3" width="8" height="8" rx="1" />
									<rect x="3" y="13" width="8" height="8" rx="1" />
									<rect x="13" y="13" width="8" height="8" rx="1" />
								</svg>
								<h2 class="section-title">@area.Name</h2>
							</div>
							<p class="section-subtitle">@runningTablesCount running / @areaTables.Count tables</p>
						</div>
						<div class="section-body">
							@if (areaTables.Count == 0)
							{
								<p class="section-subtitle">No active tables in this area</p>
							}
							else
							{
								<div class="dashboard-grid">
									@foreach (var table in areaTables)
									{
										var runningBill = _runningBills.Where(b => b.DiningTableId == table.Id && b.Running).FirstOrDefault();
										var hasRunningBill = runningBill is not null;
										var cardColor = hasRunningBill ? "running" : "available";
										var description = hasRunningBill
										? $"Bill No: {runningBill.TransactionNo}\nItems: {runningBill.TotalItems}\nQty: {runningBill.TotalQuantity.FormatSmartDecimal()}\nAmt: {runningBill.TotalAmount.FormatIndianCurrency()}"
										: $"Area: {area.Name} • Available";

										<ButtonCard Title="@table.Name"
													Description="@description"
													PreserveDescriptionLineBreaks="@hasRunningBill"
													Color="@cardColor"
													OnClick="() => OpenBillPage(table.Id)">
											<IconContent>
												<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"
													 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
													 stroke-linejoin="round">
													<rect x="3" y="4" width="18" height="5" rx="1" />
													<path d="M5 9v10" />
													<path d="M19 9v10" />
													<path d="M9 14h6" />
												</svg>
											</IconContent>
										</ButtonCard>
									}
								</div>
							}
						</div>
					</div>
				}
			}
		</div>

		<Footer />
	</div>
}